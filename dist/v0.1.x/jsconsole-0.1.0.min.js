/**
 * @license
 * Copyright (C) 2013 Steven Berry (http://www.sberry.me/jsconsole)
 * Licensed: MIT (http://opensource.org/licenses/mit-license.php)
 * License Stipulations:
 *     1) Retain this comment block.
 *     2) Send me an email if you use this and have questions/comments!
 * 
 * Steven Berry
 * www.sberry.me
 * steven@sberry.me
 */
!function(t,n,i){function e(){n(this.frame).remove(),n(this.elem).append('<iframe id="jsc-frame"></iframe>'),this.frame=n("#jsc-frame").get(0),this.sandbox=this.frame.contentWindow,this.sandbox.eval("for (var key in window.top.__jsconsole__) { console[key] = window.top.__jsconsole__[key]; }")}function r(t,n){return function(){t.apply(n,arguments)}}function s(t){return d.test(t)}function o(t,i){i="boolean"==typeof i?i:!1,this.text=n.trim(t),this.multiline=0===this.text.length?!1:i}function u(){Object.defineProperty(t.top,"__jsconsole__",{value:{log:r(this.log,this),info:r(this.info,this),warn:r(this.warn,this),error:r(this.error,this)}}),n(document.body).append('<div id="jsc-console" class="jsc-hide jsc-flex jsc-column"></div>'),this.elem=n("#jsc-console").get(0),n(this.elem).append('<textarea id="jsc-input" spellcheck="false" class="jsc-flexlock"></textarea>'),this.input=n("#jsc-input").get(0),this.input._loadHeight=n(this.input).outerHeight(),n(this.elem).append('<ul id="jsc-output"></ul>'),this.output=n("#jsc-output").get(0),e.call(this),this.history=[],this.history._index=0,this.history._unrun=null,this.hidden=!0,this.multiline=!1}var l,c="jsc-hide",h="jsc-multiline",a="jsc-resizable",f="jsc-translucent",d=/\r\n|\r|\n/,p=/[.|\r\n|\r|\n|^t|^ ]*([\t ]*).*[\r\n|\r|\n]?$/;"undefined"==typeof prettyPrintOne&&(prettyPrintOne=function(t){return t});var g=function(){function i(t){var n=[t.which];return t.shiftKey&&n.unshift("SHIFT"),t.altKey&&n.unshift("ALT"),t.ctrlKey&&n.unshift("CTRL"),n.join("+")}function e(t,i){n.isFunction(i)&&(r[t]=i)}var r={};return n(t).bind("keydown",function(t){var e,s,o;return 16!==t.which&&17!==t.which&&18!==t.which&&(s=i(t),e=r[s],n.isFunction(e))?(o=e(t),o===!0&&t.preventDefault(),o):!0}),function(t,i){n.isPlainObject(t)?n.each(t,function(t,n){e(t,n)}):e(t,i)}}(),m=function(){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return function(n){return String(n).replace(/[&<>"'\/]/g,function(n){return t[n]})}}(),v=function(){function t(t,n){return t.toLowerCase()<n.toLowerCase()?-1:1}function n(e,r){var s,o,u,l,c;if(c=Object.prototype.toString.call(e),"[object global]"===c)return c;if(e===i||null===e)return e+"";for(s=0;s<r.length;s++)if(e===r[s])return"[circular]";if("string"==typeof e)return'"'+e.replace(/"/g,'\\"')+'"';if("function"==typeof e)return"[object Function]";if(Array.isArray(e)){for(u=[],s=0;s<e.length;s++)u.push(n(e[s],r));return"["+u.join(", ")+"]"}if("object"==typeof e){l=[],u=[],r.push(e);for(o in e)l.push(o);for(l.sort(t),s=0;s<l.length;s++)u.push(n(l[s],r)+": "+n(e[l[s]],r));return"{"+u.join(", ")+"}"}return e+""}return function(t){return m(n(t,[]))}}(),y={clear:function(){return n(this.output).empty(),this},reset:function(){return e.call(this),this.info("Variables reset.")},purge:function(){return this.history.length=0,this.info("History cleared.")},load:function(){var t={jquery:"http://code.jquery.com/jquery-latest.min.js",arrx:"http://static.sberry.me/scripts/arrx-latest.js"};return function(){var n,i;for(i=this.frame.contentDocument||this.frame.contentWindow.document,n=1;n<arguments.length;n++)!function(t,n){var e=document.createElement("script");e.src=n,e.onload=function(){t.info("Loaded script from `"+n+"`"),e.onload=null,e.onerror=null},e.onerror=function(){t.error("Failed to load script from `"+n+"`"),e.onload=null,e.onerror=null},i.body.appendChild(e)}(this,t[arguments[n]]||arguments[n]);return this}}(),help:function(){var t=[":help       &ndash; Display help information.",":load &lt;url&gt; &ndash; Load external JS file.",":clear      &ndash; Clear the console.",":purge      &ndash; Clear command history.",":reset      &ndash; Clear all sandboxed variables.","","~ &ndash; Toggle console visibility.","CTRL + SHIFT + &uarr; &ndash; Change console mode (single or multi-line).","ENTER &ndash; Run a single-line command.","CTRL + ENTER &ndash; Run a multi-line command."];return function(){return this.info(t.join("\n"))}}()};u.prototype={run:function(t){var i,e,r,s=!0;if(t=n.trim(t),0!==t.length){if(":"===t.charAt(0))i=t.split(" ").filter(function(t){return t.length>0}),r=i[0].slice(1),e=y[r],n.isFunction(e)?(this.echo(t),e.apply(this,i)):this.error("Invalid command.");else try{this.echo(t),this.response(t)}catch(o){this.error(o.toString()),s=!1}s&&(this.pushHistory(t),n(this.input).val(""))}},post:function(t,i){var e=n(this.output);return e.append('<li class="jsc-'+i+'">'+t+"</li>").scrollTop(e[0].scrollHeight),this},echo:function(t){return this.post(t,"echo")},response:function(t){var n,i;return n=this.sandbox.eval(t),i=v(n),i=prettyPrintOne(i),this.post(i,"response")},log:function(t){var i,e,r;e=v(t),r=n(this.output).find("li.jsc-log").last(),r.is(":last-child")&&m(r.text())===e?(i=parseInt(r.attr("data-count")),r.attr("data-count",n.isNumeric(i)?i+1:2)):this.post(v(t),"log")},info:function(t){this.post(t.toString(),"info")},warn:function(t){this.post(t.toString(),"warn")},error:function(t){this.post(t.toString(),"error")},saveHistory:function(){var t=this.history;null===t._unrun&&(t._unrun=new o(n(this.input).val(),this.multiline))},pushHistory:function(t){var n,i=this.history;n=i[i.length-1],("undefined"==typeof n||n.text!==t||n.multiline!==this.multiline)&&(i.push(new o(t,this.multiline)),i._unrun=null,i._index=i.length)},nextHistory:function(){var t,i=this.history;this.saveHistory(),i._index<i.length&&i._index++,i._index===i.length?(t=i._unrun,i._unrun=null):t=i[i._index],n(this.input).val(t.text),this.toggleMode(!t.multiline)},prevHistory:function(){var t,i=this.history;this.saveHistory(),i._index>0&&i._index--,t=i[i._index],"undefined"!=typeof t&&(n(this.input).val(t.text),this.toggleMode(!t.multiline))},toggleDisplay:function(t){var i=n(this.elem),e=n(this.input);i.hasClass(c)||t===!0?(i.removeClass(c),this.hidden=!1,e.focus()):(i.addClass(c),this.hidden=!0,e.blur())},toggleMode:function(t){var i=n(this.input);"undefined"==typeof t&&(t=this.multiline),t===!0?(i.css("height",this.input._loadHeight).removeClass(h+" "+a),this.multiline=!1):(i.css("height","50%").addClass(h),this.multiline=!0)},toggleResizable:function(){this.multiline&&n(this.input).toggleClass(a)},toggleTransparency:function(){n(this.elem).toggleClass(f)}},n.jsconsole=function(){if(l instanceof u)return l;l=new u;var t=n.Event("keydown");t.which=t.keyCode=9;var i=n.Event("keydown");return i.which=i.keyCode=32,n(l.input).bind("keydown",function(t){var i,e,r,s,o,u,c="";if(9==t.which&&l.multiline)if(t.preventDefault(),o=n(this),u=o.val(),s=this.selectionStart,r=this.selectionEnd,s===r)o.val(u.substring(0,s)+"	"+u.substring(r)),this.selectionStart=this.selectionEnd=s+1;else{if(e=u.substring(s,r).split(d),t.shiftKey)for(i=0;i<e.length;i++)c+=e[i].replace(/\t/,"")+"\n";else for(i=0;i<e.length;i++)c+="	"+e[i]+"\n";c=c.replace(/\n$/,""),o.val(u.substring(0,s)+c+u.substring(r)),this.selectionStart=s,this.selectionEnd=s+c.length}}),n(l.input).bind("keyup",function(e){var r,s,o,u,c,h;if(13==e.which&&!e.ctrlKey&&l.multiline)for(e.preventDefault(),h=n(this),c=h.val(),u=this.selectionStart,s=this.selectionEnd,o=p.exec(c.substring(0,u))[1],r=0;r<o.length;r++)/\t/.test(o[r])?h.trigger(t):/ /.test(o[r])&&h.trigger(i)}),g({192:function(){return l.toggleDisplay(),!0},"CTRL+SHIFT+38":function(){var t=n(l.input);return t.is(":focus")?l.multiline&&s(t.val())?(l.info("Cannot switch to single-line mode while editing multi-line code."),!1):(l.toggleMode(),!0):void 0},"CTRL+ALT+84":function(){return l.hidden?void 0:(l.toggleTransparency(),!0)}}),g({"CTRL+SHIFT+40":function(){return n(l.input).is(":focus")?(l.toggleResizable(),!0):void 0},"CTRL+38":function(){return n(l.input).is(":focus")?(l.prevHistory(),!0):void 0},"CTRL+40":function(){return n(l.input).is(":focus")?(l.nextHistory(),!0):void 0},"CTRL+13":function(){var t=n(l.input);return t.is(":focus")?(l.run(t.val()),!0):void 0}}),g({38:function(){return n(l.input).is(":focus")&&!l.multiline?(l.prevHistory(),!0):void 0},40:function(){return n(l.input).is(":focus")&&!l.multiline?(l.nextHistory(),!0):void 0},13:function(){var t=n(l.input);return t.is(":focus")&&!l.multiline?(l.run(t.val()),!0):void 0}}),l},n.jsconsole.isMultiline=s,n.jsconsole.keybind=g}(window,jQuery);